<!DOCTYPE html>
<html>
<head>
<title>Post</title>

<meta name="viewport" content="width=device-width, initial-scale=1">

<style>

/* ===== RESET ===== */

*{
    margin:0;
    padding:0;
    box-sizing:border-box;
    font-family:-apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
}

body{
    background:#f9f9f9;
    color:#111;
}

/* ===== NAVBAR ===== */

.navbar{
    background:black;
    color:white;
    padding:18px 40px;
    display:flex;
    justify-content:space-between;
    align-items:center;
}

.navbar button{
    background:white;
    color:black;
    border:none;
    padding:8px 16px;
    border-radius:20px;
    cursor:pointer;
}

/* ===== CONTAINER ===== */

.container{
    max-width:900px;
    margin:auto;
    padding:40px 20px;
}

/* ===== POST CARD ===== */

h1{
    font-size:32px;
    margin-bottom:10px;
}

.author{
    color:#666;
    margin-bottom:25px;
}

.post-content{
    background:white;
    padding:25px;
    border-radius:18px;
    box-shadow:0 4px 14px rgba(0,0,0,0.06);
    line-height:1.6;
}

/* Owner buttons */

#ownerActions{
    margin-top:20px;
}

.edit-btn,
.delete-btn{
    padding:9px 18px;
    border:none;
    border-radius:20px;
    cursor:pointer;
    margin-right:10px;
}

.edit-btn{
    background:black;
    color:white;
}

.delete-btn{
    background:#eee;
}

/* ===== COMMENTS ===== */

h2{
    margin:35px 0 20px 0;
}

.comment{
    background:white;
    padding:18px;
    border-radius:14px;
    box-shadow:0 2px 10px rgba(0,0,0,0.05);
    margin-bottom:15px;
}

.comment strong{
    display:block;
    margin-bottom:6px;
}

/* Comment section */

textarea{
    width:100%;
    height:110px;
    padding:14px;
    border-radius:12px;
    border:1px solid #ddd;
    resize:none;
}

#commentBtn{
    margin-top:12px;
    padding:10px 20px;
    background:black;
    color:white;
    border:none;
    border-radius:22px;
    cursor:pointer;
}

/* Responsive */

@media(max-width:600px){
    .navbar{
        padding:15px 20px;
    }

    .container{
        padding:25px 15px;
    }
}

</style>

</head>

<body>

<div class="navbar">
<div class="logo">BlogApp</div>
<div>
<button onclick="goHome()">Home</button>
<button onclick="logout()">Logout</button>
</div>
</div>

<div class="container">

<h1 id="title"></h1>
<div id="author" class="author"></div>

<p id="content" class="post-content"></p>

<div id="ownerActions" style="display:none;">
<button class="edit-btn" onclick="editPost()">Edit</button>
<button class="delete-btn" onclick="deletePost()">Delete</button>
</div>

<h2>Comments</h2>
<div id="comments"></div>

<div id="commentSection" style="display:none;">
<textarea id="commentContent" placeholder="Write comment..."></textarea>
<button id="commentBtn">Post Comment</button>
</div>

</div>

<script>

const API_BASE="http://localhost:8080";
const params=new URLSearchParams(window.location.search);
const id=params.get("id");

/* ===== AUTH ===== */

function getToken(){
    return localStorage.getItem("token");
}

function getLoggedInUser(){

    const token=getToken();
    if(!token) return null;

    try{
        const payload=JSON.parse(atob(token.split('.')[1]));
        return payload.username;
    }catch{
        return null;
    }
}

function logout(){
    localStorage.removeItem("token");
    window.location.href="login.html";
}

function goHome(){
    window.location.href="index.html";
}

/* ===== LOAD POST ===== */

async function loadPost(){

    try{

        const res=await fetch(`${API_BASE}/post/${id}`);
        if(!res.ok) throw new Error();

        const post=await res.json();

        document.getElementById("title").innerText=post.title;
        document.getElementById("author").innerText="By "+post.author;
        document.getElementById("content").innerText=post.content;

        const loggedUser=getLoggedInUser();

        if(loggedUser && loggedUser===post.author){
            document.getElementById("ownerActions").style.display="block";
        }

    }catch{
        document.querySelector(".container").innerHTML="<h2>Post not found.</h2>";
    }
}

loadPost();

/* ===== COMMENTS ===== */

async function loadComments(){

    try{

        const res=await fetch(`${API_BASE}/posts/${id}/comments`);
        const comments=await res.json();

        const div=document.getElementById("comments");
        div.innerHTML="";

        if(!comments || comments.length===0){
            div.innerHTML="<p>No comments yet.</p>";
            return;
        }

        comments.forEach(c=>{
            const el=document.createElement("div");
            el.className="comment";
            el.innerHTML=`
                <strong>${c.author}</strong>
                <p>${c.content}</p>
            `;
            div.appendChild(el);
        });

    }catch{
        document.getElementById("comments").innerHTML="<p>Error loading comments.</p>";
    }
}

loadComments();

/* ===== ADD COMMENT ===== */

if(getToken()){
    document.getElementById("commentSection").style.display="block";
}

document.getElementById("commentBtn").addEventListener("click",async()=>{

    const token=getToken();
    if(!token){
        alert("Please login first");
        return;
    }

    const content=document.getElementById("commentContent").value.trim();

    if(!content){
        alert("Comment cannot be empty");
        return;
    }

    try{

        const res=await fetch(`${API_BASE}/comments`,{
            method:"POST",
            headers:{
                "Content-Type":"application/json",
                "Authorization":`Bearer ${token}`
            },
            body:JSON.stringify({
                post_id:parseInt(id),
                content:content
            })
        });

        if(!res.ok) throw new Error();

        document.getElementById("commentContent").value="";
        loadComments();

    }catch{
        alert("Failed to add comment");
    }
});

/* ===== EDIT / DELETE ===== */

function editPost(){
    window.location.href=`editpost.html?id=${id}`;
}

async function deletePost(){

    const token=getToken();
    if(!token) return;

    if(!confirm("Delete post?")) return;

    try{

        const res=await fetch(`${API_BASE}/post/${id}`,{
            method:"DELETE",
            headers:{
                "Authorization":`Bearer ${token}`
            }
        });

        if(!res.ok) throw new Error();

        alert("Post deleted");
        window.location.href="index.html";

    }catch{
        alert("Delete failed");
    }
}

</script>

</body>
</html>